{% extends 'base.html' %}

{% block title %}Return Book - AOA Library{% endblock %}

{% block page_header %}
<div class="page-header d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Return Book</h3>
</div>
{% endblock %}

{% block content %}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    <span>{{ message }}</span>
                    <button class="alert-close" onclick="this.parentElement.remove()">&times;</button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="form-container">
        <form method="POST" action="{{ url_for('operation_bp.return_book') }}">
            <div class="form-row">
                <div class="form-group">
                    <label for="student">STUDENT</label>
                    <select id="student" name="student_id" required onchange="loadStudentBooks()" class="form-select">
                        <option value="">Select Student</option>
                        {% for student in students %}
                        <option value="{{ student.userid }}">{{ student.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="title">TITLE</label>
                    <select id="title" name="title" required onchange="loadBooks()" class="form-select">
                        <option value="">Select Title</option>
                        {% for book in books %}
                        <option value="{{ book }}">{{ book }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>BOOK IDs</label>
                <div class="book-ids-selector">
                    <div id="selectedBooks" class="selected-books"></div>
                    <button type="button" onclick="openBookSelector()" class="btn btn-secondary">Select Book IDs</button>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="return_date">DATE RETURNED</label>
                    <input type="date" id="return_date" name="return_date" required class="form-control">
                </div>

                <div class="form-group">
                    <label for="returned_by">RETURNED BY</label>
                    <select id="returned_by" name="returned_by" required class="form-select">
                        <option value="">Select Staff</option>
                        {% for staff in staff_members %}
                        <option value="{{ staff }}">{{ staff }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <input type="hidden" id="book_ids" name="book_ids">
            <button type="submit" class="btn btn-success btn-block">RETURN</button>
        </form>
    </div>

    <!-- Book Selector Modal -->
    <div id="bookModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeBookSelector()">&times;</span>
            <h2>Select Book IDs</h2>
            <input type="text" id="bookSearch" placeholder="Search books..." class="search-input form-control mb-2">
            <div id="bookList" class="modal-list"></div>
            <div class="modal-actions mt-2">
                <button onclick="confirmSelection()" class="btn btn-primary">Add Selected</button>
                <button onclick="closeBookSelector()" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    let selectedBooks = [];

    function loadStudentBooks() {
        const studentId = document.getElementById('student').value;
        if (!studentId) return;

        fetch(`/api/get_titles?student_id=${encodeURIComponent(studentId)}`)
            .then(res => res.json())
            .then(titles => {
                const select = document.getElementById('title');
                select.innerHTML = '<option value="">Select Title</option>';
                titles.forEach(title => {
                    const option = document.createElement('option');
                    option.value = title;
                    option.textContent = title;
                    select.appendChild(option);
                });
            });
    }

    function loadBooks() {
        openBookSelector();
    }

    function openBookSelector() {
        const studentId = document.getElementById('student').value;
        const title = document.getElementById('title').value;

        if (!studentId || !title) {
            alert('Please select both student and title');
            return;
        }

        fetch(`/api/get_student_books?student_id=${encodeURIComponent(studentId)}&title=${encodeURIComponent(title)}`)
            .then(res => res.json())
            .then(books => {
                const list = document.getElementById('bookList');
                list.innerHTML = '';
                books.forEach(book => {
                    const div = document.createElement('div');
                    div.className = 'book-item';
                    div.innerHTML = `
                        <label>
                            <input type="checkbox" value="${book}" onchange="toggleBook('${book}')">
                            ${book}
                        </label>
                    `;
                    list.appendChild(div);
                });
                document.getElementById('bookModal').style.display = 'block';
            });
    }

    function closeBookSelector() {
        document.getElementById('bookModal').style.display = 'none';
    }

    function toggleBook(bookId) {
        const checkbox = document.querySelector(`input[value="${bookId}"]`);
        if (checkbox.checked) {
            if (!selectedBooks.includes(bookId)) {
                selectedBooks.push(bookId);
            }
        } else {
            selectedBooks = selectedBooks.filter(id => id !== bookId);
        }
        updateSelectedDisplay();
    }

    function confirmSelection() {
        updateSelectedDisplay();
        closeBookSelector();
    }

    function updateSelectedDisplay() {
        const display = document.getElementById('selectedBooks');
        document.getElementById('book_ids').value = JSON.stringify(selectedBooks);

        if (selectedBooks.length === 0) {
            display.innerHTML = '<span class="text-muted">No books selected</span>';
            return;
        }

        display.innerHTML = '';
        const showBooks = selectedBooks.slice(0, 3);
        showBooks.forEach(book => {
            const badge = document.createElement('span');
            badge.className = 'book-badge';
            badge.innerHTML = `${book} <span onclick="removeBook('${book}')">Ã—</span>`;
            display.appendChild(badge);
        });

        if (selectedBooks.length > 3) {
            const more = document.createElement('span');
            more.className = 'text-muted';
            more.textContent = ` (+${selectedBooks.length - 3} more)`;
            display.appendChild(more);
        }
    }

    function removeBook(bookId) {
        selectedBooks = selectedBooks.filter(id => id !== bookId);
        updateSelectedDisplay();
    }

    // Set default return date (today)
    document.getElementById('return_date').value = new Date().toISOString().split('T')[0];

    // Search functionality
    document.getElementById('bookSearch').addEventListener('input', function(e) {
        const search = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.book-item');
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(search) ? 'block' : 'none';
        });
    });
</script>
<script src="{{ url_for('static', filename='js/alerts.js') }}"></script>
{% endblock %}

