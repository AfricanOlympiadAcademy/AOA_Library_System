{% extends 'base.html' %}

{% block title %}Test Email - AOA Library{% endblock %}

{% block page_header %}
<div class="page-header d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Test Email Configuration</h3>
</div>
{% endblock %}

{% block content %}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    <span>{{ message }}</span>
                    <button class="alert-close" onclick="this.parentElement.remove()">&times;</button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="form-container">
        <h4>Email Configuration Status</h4>
        
        <h5 style="margin-top: 20px;">Environment Variables (from Render):</h5>
        <table class="table" style="margin-bottom: 20px;">
            <tr>
                <td><strong>EMAIL_ADDRESS:</strong></td>
                <td>{{ env_check.EMAIL_ADDRESS }}</td>
            </tr>
            <tr>
                <td><strong>RESEND_API_KEY:</strong></td>
                <td>
                    {% if env_check.RESEND_API_KEY == 'Set' %}
                        <span style="color: green;">✓ Set</span>
                    {% else %}
                        <span style="color: red;">✗ Not Set</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td><strong>EMAIL_ENABLED:</strong></td>
                <td>{{ env_check.EMAIL_ENABLED }}</td>
            </tr>
        </table>
        
        <h5 style="margin-top: 20px;">Loaded Configuration:</h5>
        <table class="table" style="margin-bottom: 30px;">
            <tr>
                <td><strong>Provider:</strong></td>
                <td><span style="color: #0066cc; font-weight: bold;">Resend API</span></td>
            </tr>
            <tr>
                <td><strong>Email Enabled:</strong></td>
                <td>
                    {% if config.enabled %}
                        <span style="color: green;">✓ Yes</span>
                    {% else %}
                        <span style="color: red;">✗ No</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td><strong>From Email Address:</strong></td>
                <td>{{ config.email_address }}</td>
            </tr>
            <tr>
                <td><strong>Resend API Key:</strong></td>
                <td>
                    {% if config.has_resend_key %}
                        <span style="color: green;">✓ Set</span>
                    {% else %}
                        <span style="color: red;">✗ Not Set</span>
                    {% endif %}
                </td>
            </tr>
        </table>

        {% if not config.has_resend_key %}
        <div class="alert alert-error" style="background-color: #f8d7da; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <strong>⚠️ Resend API Key Not Set!</strong><br>
            You need to set the <code>RESEND_API_KEY</code> environment variable in Render Dashboard.
            <ol style="margin-top: 10px; padding-left: 20px;">
                <li>Go to <a href="https://dashboard.render.com" target="_blank">Render Dashboard</a></li>
                <li>Select your service: <strong>aoa-library-system</strong></li>
                <li>Go to <strong>Environment</strong> tab</li>
                <li>Add: <code>RESEND_API_KEY</code> = <code>your-resend-api-key</code></li>
                <li>Save and redeploy</li>
            </ol>
        </div>
        {% endif %}

        <h4>Send Test Email</h4>
        <form method="POST" action="{{ url_for('test_email') }}">
            <div class="form-group">
                <label for="test_email">Test Email Address</label>
                <input type="email" id="test_email" name="test_email" required class="form-control" placeholder="your-email@example.com">
                <small class="form-text">Enter an email address to send a test email to</small>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Send Test Email</button>
        </form>

        <div style="margin-top: 30px; padding: 15px; background-color: #f8f9fa; border-radius: 5px;">
            <h5>How to Set Environment Variables in Render:</h5>
            <ol>
                <li>Go to <a href="https://dashboard.render.com" target="_blank">https://dashboard.render.com</a></li>
                <li>Click on your service: <strong>aoa-library-system</strong></li>
                <li>Click <strong>Environment</strong> in the left sidebar</li>
                <li>Click <strong>"Add Environment Variable"</strong></li>
                <li>Add these variables:
                    <ul>
                        <li><code>EMAIL_ENABLED</code> = <code>true</code></li>
                        <li><code>EMAIL_ADDRESS</code> = <code>tech@africanolympiadfoundation.org</code></li>
                        <li><code>RESEND_API_KEY</code> = <code>your-resend-api-key</code> (IMPORTANT!)</li>
                        <li><code>LIBRARY_NAME</code> = <code>AOA Library</code></li>
                    </ul>
                </li>
                <li>Click <strong>"Save Changes"</strong> - Render will auto-redeploy</li>
            </ol>
            
            <h5 style="margin-top: 20px;">Get Your Resend API Key:</h5>
            <p>You need a Resend API key from <a href="https://resend.com" target="_blank">resend.com</a>:</p>
            <ol>
                <li>Go to <a href="https://resend.com/login" target="_blank">Resend Login</a> and sign in</li>
                <li>Navigate to <strong>API Keys</strong> in the dashboard</li>
                <li>Click <strong>"Create API Key"</strong></li>
                <li>Give it a name (e.g., "AOA Library Production")</li>
                <li>Copy the generated API key (starts with "re_")</li>
                <li>Add it as <code>RESEND_API_KEY</code> in Render Environment Variables</li>
            </ol>
            <p style="margin-top: 15px;"><strong>Note:</strong> Make sure your sending domain (<code>africanolympiadfoundation.org</code>) is verified in Resend. The DNS records shown at the top of this page should be added to your domain's DNS settings.</p>
        </div>
    </div>
{% endblock %}

